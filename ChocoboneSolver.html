<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHOCOBONING - Instant Dashboard</title>
    <style>
        /* Import 8-bit Retro Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');

        body { 
            font-family: 'VT323', monospace; 
            font-size: 22px;
            background: #1e1e24; 
            color: #f5f5f5; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            margin: 0;
            padding-bottom: 60px; /* Space for the bottom panel */
        }
        
        /* Title Header */
        .header-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            margin-top: 10px;
        }
        .header-title h1 { 
            font-family: 'Press Start 2P', cursive;
            margin: 0; 
            font-size: 32px; 
            color: #ffeb3b;
            text-shadow: 4px 4px 0px #000;
            letter-spacing: 2px;
        }
        .hearts {
            font-size: 32px;
            filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.8));
        }

        /* Sticky Header */
        .controls-wrapper {
            position: sticky;
            top: 0;
            background: rgba(30, 30, 36, 0.95);
            padding: 15px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 4px solid #4a4ae6;
            z-index: 100;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            gap: 20px;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .control-group label {
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            color: #aaa;
            margin-top: 4px; 
        }
        select { 
            font-family: 'VT323', monospace;
            padding: 4px 12px; 
            font-size: 22px; 
            border-radius: 0px; 
            border: 4px solid #5c5cff; 
            cursor: pointer; 
            background: #2b2b36; 
            color: #fff; 
        }

        /* Map Dashboard Layout */
        .dashboard {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 800px;
        }

        .map-card {
            background: #2b2b36;
            border-radius: 0px;
            padding: 10px 15px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 20px;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.4);
            border-left: 8px solid; 
        }

        /* Miniature Visual Grid */
        .grid-container { flex-shrink: 0; }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(6, 28px); 
            gap: 2px; 
            background: #111;
            padding: 4px;
            border-radius: 0px;
        }
        .cell { 
            font-family: 'VT323', monospace;
            width: 28px; 
            height: 28px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 18px; 
            border-radius: 0px;
            user-select: none;
        }
        .cell.O { background-color: #4caf50; color: white; }
        .cell.X { background-color: #f44336; color: rgba(255,255,255,0.8); font-size: 22px; }
        .interactive .cell { cursor: pointer; transition: transform 0.1s; }
        .interactive .cell:hover { transform: scale(1.1); background-color: #fff; color: #000; }

        /* Advice Text */
        .advice-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .rush { font-family: 'Press Start 2P', cursive; color: #4caf50; font-size: 14px; margin-bottom: 8px; text-shadow: 2px 2px 0px #000; line-height: 1.4;}
        .wait { font-family: 'Press Start 2P', cursive; color: #ffeb3b; font-size: 14px; margin-bottom: 8px; text-shadow: 2px 2px 0px #000; line-height: 1.4;}
        .rush-med { font-family: 'Press Start 2P', cursive; color: #ff9800; font-size: 12px; margin-bottom: 8px; line-height: 1.4;}
        
        .sub-advice { color: #aaa; font-size: 20px; }

        .counter-table { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            background: #1e1e24;
            padding: 8px;
            border-radius: 0px;
            border: 2px solid #111;
        }
        .counter-item { background: #3a3a48; padding: 4px 8px; text-align: center; }
        .win { color: #4caf50; }
        .tie { color: #ffeb3b; }
        .lose { color: #f44336; }

        /* Overall Stats Bottom Panel */
        .overall-stats-container {
            margin-top: 40px;
            width: 100%;
            max-width: 800px;
            background: #1a1a24;
            border: 4px solid #ffeb3b;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.6);
        }
        .overall-stats-container h2 {
            font-family: 'Press Start 2P', cursive;
            margin-top: 0;
            color: #ffeb3b;
            font-size: 16px;
            text-align: center;
            text-shadow: 2px 2px 0px #000;
            margin-bottom: 20px;
        }
        .stats-grid {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        .stat-box {
            background: #2b2b36;
            flex: 1;
            padding: 15px;
            border: 4px solid #333;
            text-align: center;
        }
        .stat-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            margin-bottom: 10px;
            color: #fff;
        }
        .yolo-title { color: #ff7675; }
        .counter-title { color: #74b9ff; }
        .stat-value {
            font-size: 32px;
            color: #4caf50;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-desc {
            color: #aaa;
            font-size: 20px;
        }

        /* Custom Builder Section */
        .custom-builder-container {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 4px dashed #444;
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #22222b;
            padding: 20px;
            box-sizing: border-box;
            margin-bottom: 40px;
        }
        .custom-builder-container h2 { font-family: 'Press Start 2P', cursive; margin-top: 0; color: #81ecec; font-size: 16px; text-shadow: 2px 2px 0px #000; }
        .builder-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
            justify-content: center;
        }
        .builder-controls input[type="color"] {
            border: 4px solid #111;
            background: transparent;
            cursor: pointer;
            height: 38px;
            width: 38px;
            padding: 0;
        }
        .btn {
            font-family: 'VT323', monospace;
            padding: 4px 15px;
            font-size: 22px;
            border: 4px solid #111;
            border-radius: 0px;
            cursor: pointer;
            background: #5c5cff;
            color: white;
            text-transform: uppercase;
        }
        .btn:hover { background: #4a4ae6; }
        .btn-danger { background: #d63031; padding: 4px 12px; font-size: 20px;}
        .btn-danger:hover { background: #b83232; }

    </style>
</head>
<body>

    <div class="header-title">
        <span class="hearts">‚ù§Ô∏è‚ù§Ô∏è</span>
        <h1>CHOCOBONING</h1>
        <span class="hearts">‚ù§Ô∏è‚ù§Ô∏è</span>
    </div>

    <div class="controls-wrapper">
        <div class="control-group">
            <label>TARGET GOAL:</label>
            <select id="targetGoal" onchange="updateAll()">
                <option value="0">Row 1 (Top)</option>
                <option value="1">Row 2 (Mid)</option>
                <option value="2">Row 3 (Bot)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>RIVAL PICKED:</label>
            <select id="rivalStart" onchange="updateAll()">
                <option value="-1">None (I pick first)</option>
                <option value="0">Row 1 (Top)</option>
                <option value="1">Row 2 (Mid)</option>
                <option value="2">Row 3 (Bot)</option>
            </select>
        </div>

        <button class="btn btn-danger" onclick="resetDefaults()" style="margin-left: auto;">Reset Layouts</button>
    </div>

    <div id="dashboard" class="dashboard"></div>

    <div class="overall-stats-container">
        <h2>OVERALL PANIC STATS (NO TIME TO CHECK)</h2>
        <div class="stats-grid">
            <div class="stat-box" style="border-color: #ff7675;">
                <div class="stat-title yolo-title">YOLO ROUTE</div>
                <div class="stat-value" id="yoloVal">--</div>
                <div class="stat-desc" id="yoloDesc">--</div>
            </div>
            <div class="stat-box" style="border-color: #74b9ff;">
                <div class="stat-title counter-title">COUNTER ROUTE</div>
                <div class="stat-value" id="counterVal">--</div>
                <div class="stat-desc" id="counterDesc">Chance to NOT lose if you blindly wait.</div>
            </div>
        </div>
    </div>

    <div class="custom-builder-container">
        <h2>BUILD CUSTOM LAYOUT</h2>
        <p style="color: #aaa; margin-top: 0; font-size: 20px;">Click the grid squares to toggle üåø and X. Solution is automatic.</p>
        
        <div class="builder-controls">
            <input type="color" id="customColor" value="#fd79a8" title="Pick a color for the sidebar">
            <button class="btn" onclick="saveCustomMap()">Save to Dashboard</button>
        </div>

        <div class="map-card interactive" style="border-left-color: #fd79a8; width: 100%; box-sizing: border-box;" id="customCardColor">
            <div class="grid-container" id="customGridElement"></div>
            <div class="advice-panel" id="customAdvice"></div>
        </div>
    </div>

    <script>
        // Grouped together by their exact visual shapes
        const defaultMaps = [
            // Path 1 Family
            { id: "Red", color: "#ff7675", data: "XOOXXO" + "OOOOOO" + "OXXOOX" },
            { id: "Green", color: "#55efc4", data: "OXXOOX" + "OOOOOO" + "XOOXXO" },
            // Path 2 Family
            { id: "Grey", color: "#dfe6e9", data: "OXOXOX" + "OOOOOO" + "XOXOXO" },
            { id: "Cyan", color: "#00cec9", data: "XOXOXO" + "OOOOOO" + "OXOXOX" },
            // Path 3 Family
            { id: "Blue", color: "#74b9ff", data: "XOXOOX" + "OOOOOO" + "OXOXXO" },
            { id: "Purple", color: "#a29bfe", data: "OXXOXO" + "OOOOOO" + "XOOXOX" },
            { id: "Orange", color: "#fab1a0", data: "OXOXXO" + "OOOOOO" + "XOXOOX" },
            { id: "Yellow", color: "#ffeaa7", data: "XOOXOX" + "OOOOOO" + "OXXOXO" }
        ];

        let mapList = JSON.parse(localStorage.getItem('chocoMaps')) || [...defaultMaps];
        let customGridData = Array(18).fill('O');

        document.getElementById('customColor').addEventListener('input', function(e) {
            document.getElementById('customCardColor').style.borderLeftColor = e.target.value;
        });

        function simulate(gridArr, pStartRow, rStartRow) {
            let pRow = pStartRow; let rRow = rStartRow;
            let pDelay = 0; let rDelay = 0;
            for (let c = 0; c < 6; c++) {
                let isTop = (gridArr[c] === 'O' && gridArr[c+6] === 'O');
                let isBot = (gridArr[c+6] === 'O' && gridArr[c+12] === 'O');
                let pWants = (isTop && (pRow === 0 || pRow === 1)) || (isBot && (pRow === 1 || pRow === 2));
                let rWants = (isTop && (rRow === 0 || rRow === 1)) || (isBot && (rRow === 1 || rRow === 2));
                if (pWants && rWants && pRow !== rRow) {
                    let pArrive = c + pDelay; let rArrive = c + rDelay;
                    if (pArrive === rArrive) { pDelay++; rDelay++; } // Bounce
                    else { // Pass
                        pRow = isTop ? (pRow === 0 ? 1 : 0) : (pRow === 1 ? 2 : 1);
                        rRow = isTop ? (rRow === 0 ? 1 : 0) : (rRow === 1 ? 2 : 1);
                        pDelay++; rDelay++;
                    }
                } else {
                    if (pWants) { pRow = isTop ? (pRow === 0 ? 1 : 0) : (pRow === 1 ? 2 : 1); pDelay++; }
                    if (rWants) { rRow = isTop ? (rRow === 0 ? 1 : 0) : (rRow === 1 ? 2 : 1); rDelay++; }
                }
            }
            return { pEnd: pRow, rEnd: rRow };
        }

        function getScore(pEnd, rEnd, target) {
            if (pEnd === target) return 1.0; 
            if (rEnd !== target) return 0.5; // Tie
            return 0.0; 
        }

        function analyze(mapData, target, rivalStart) {
            let gridArr = mapData.split('');
            let outcomes = [];
            for(let p=0; p<3; p++) {
                for(let r=0; r<3; r++) {
                    if(p === r) continue;
                    let res = simulate(gridArr, p, r);
                    outcomes.push({ pStart: p, rStart: r, score: getScore(res.pEnd, res.rEnd, target) });
                }
            }

            let html = '';

            if (rivalStart === -1) {
                // DEFAULT MODE: I pick first
                let rushEVs = {0:0, 1:0, 2:0}; let count = {0:0, 1:0, 2:0};
                outcomes.forEach(o => { rushEVs[o.pStart] += o.score; count[o.pStart]++; });
                let bestRushEV = -1; let bestRushLane = -1;
                for(let i=0; i<3; i++) {
                    rushEVs[i] /= count[i];
                    if(rushEVs[i] > bestRushEV) { bestRushEV = rushEVs[i]; bestRushLane = i; }
                }

                let waitTotalEV = 0; let waitAdvice = [];
                for(let r=0; r<3; r++) {
                    let bestP = -1; let bestS = -1;
                    outcomes.filter(o => o.rStart === r).forEach(o => {
                        if(o.score > bestS) { bestS = o.score; bestP = o.pStart; }
                    });
                    waitTotalEV += (bestS / 3);
                    let resultClass = bestS === 1.0 ? 'win' : (bestS === 0.5 ? 'tie' : 'lose');
                    waitAdvice.push(`<div class="counter-item">Rival ${r+1} ‚ûî <b class="${resultClass}">${bestP+1}</b></div>`);
                }

                if (bestRushEV === 1.0) {
                    html += `<div class="rush">üö® RUSH ROW ${bestRushLane + 1}</div>`;
                    html += `<div class="sub-advice">You win 100% of the time.</div>`;
                } else if (waitTotalEV > bestRushEV) {
                    html += `<div class="wait">‚è≥ WAIT & COUNTER</div>`;
                    html += `<div class="counter-table">${waitAdvice.join('')}</div>`;
                } else {
                    html += `<div class="rush-med">ü§î RUSH ROW ${bestRushLane + 1} (${Math.round(bestRushEV*100)}% Win)</div>`;
                    html += `<div class="sub-advice">Highest immediate odds.</div>`;
                }
            } else {
                // REACTIVE MODE: Rival picked first
                let bestP = -1; let bestS = -1;
                outcomes.filter(o => o.rStart === rivalStart).forEach(o => {
                    if(o.score > bestS) { bestS = o.score; bestP = o.pStart; }
                });

                let resultText = bestS === 1.0 ? 'WIN' : (bestS === 0.5 ? 'TIE (0.5 pts)' : 'LOSE');
                let resultColor = bestS === 1.0 ? '#4caf50' : (bestS === 0.5 ? '#ffeb3b' : '#f44336');

                html += `<div style="font-family: 'Press Start 2P', cursive; color: ${resultColor}; font-size: 16px; margin-bottom: 8px; text-shadow: 2px 2px 0px #000; line-height: 1.4;">`;
                html += `PICK ROW ${bestP + 1}`;
                html += `</div>`;
                html += `<div class="sub-advice">Result: <span style="color:${resultColor}; font-weight:bold;">${resultText}</span></div>`;
            }

            return html;
        }

        function createStaticGridHTML(mapData) {
            let html = '<div class="grid">';
            for(let char of mapData) { 
                let displayChar = char === 'O' ? 'üåø' : 'X';
                html += `<div class="cell ${char}">${displayChar}</div>`; 
            }
            return html + '</div>';
        }

        function renderCustomBuilder() {
            const container = document.getElementById('customGridElement');
            let html = '<div class="grid">';
            customGridData.forEach((char, index) => {
                let displayChar = char === 'O' ? 'üåø' : 'X';
                html += `<div class="cell ${char}" onclick="toggleCustomCell(${index})">${displayChar}</div>`;
            });
            html += '</div>';
            container.innerHTML = html;
            
            const target = parseInt(document.getElementById('targetGoal').value);
            const rivalStart = parseInt(document.getElementById('rivalStart').value);
            document.getElementById('customAdvice').innerHTML = analyze(customGridData.join(''), target, rivalStart);
        }

        function toggleCustomCell(index) {
            customGridData[index] = customGridData[index] === 'O' ? 'X' : 'O';
            renderCustomBuilder();
        }

        function saveCustomMap() {
            const color = document.getElementById('customColor').value;
            const dataStr = customGridData.join('');
            
            if (mapList.some(m => m.data === dataStr)) {
                alert("This layout already exists in your list!");
                return;
            }

            mapList.push({ id: `Custom-${mapList.length + 1}`, color: color, data: dataStr });
            localStorage.setItem('chocoMaps', JSON.stringify(mapList));
            updateAll();
        }

        function resetDefaults() {
            if (confirm("Are you sure you want to delete all your custom layouts and return to the defaults?")) {
                localStorage.removeItem('chocoMaps');
                mapList = [...defaultMaps];
                updateAll();
            }
        }

        function renderDashboard(target, rivalStart) {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';

            mapList.forEach(map => {
                const card = document.createElement('div');
                card.className = 'map-card';
                card.style.borderLeftColor = map.color;
                
                card.innerHTML = `
                    <div class="grid-container">
                        ${createStaticGridHTML(map.data)}
                    </div>
                    <div class="advice-panel">
                        ${analyze(map.data, target, rivalStart)}
                    </div>
                `;
                dashboard.appendChild(card);
            });
        }

        function calculateOverallStats(target) {
            let yoloCounts = {0: 0, 1: 0, 2: 0};
            let totalYoloScenarios = mapList.length * 2; // Each map has 2 possible rival choices if we rush

            let counterSuccesses = 0;
            let totalCounterScenarios = mapList.length * 3; // Rival picks first (3 choices) across all maps

            mapList.forEach(map => {
                let gridArr = map.data.split('');
                
                // YOLO Logic (We pick p, rival picks random from other 2)
                for(let p=0; p<3; p++) {
                    for(let r=0; r<3; r++) {
                        if (p === r) continue;
                        let res = simulate(gridArr, p, r);
                        let score = getScore(res.pEnd, res.rEnd, target);
                        if (score > 0) yoloCounts[p]++; // Count Win or Tie
                    }
                }

                // COUNTER Logic (Rival picks r, we perfectly pick best p)
                for(let r=0; r<3; r++) {
                    let bestScore = -1;
                    for(let p=0; p<3; p++) {
                        if (p === r) continue;
                        let res = simulate(gridArr, p, r);
                        let score = getScore(res.pEnd, res.rEnd, target);
                        if (score > bestScore) bestScore = score;
                    }
                    if (bestScore > 0) counterSuccesses++; // Count Win or Tie
                }
            });

            // Find best YOLO row
            let bestYoloRow = 0;
            let bestYoloCount = -1;
            for(let p=0; p<3; p++) {
                if (yoloCounts[p] > bestYoloCount) {
                    bestYoloCount = yoloCounts[p];
                    bestYoloRow = p;
                }
            }
            
            let yoloPercent = Math.round((bestYoloCount / totalYoloScenarios) * 100);
            let counterPercent = Math.round((counterSuccesses / totalCounterScenarios) * 100);

            // Update DOM
            document.getElementById('yoloVal').innerText = yoloPercent + "%";
            document.getElementById('yoloDesc').innerHTML = `Chance of NOT losing if you blindly <strong style="color:#fff;">RUSH ROW ${bestYoloRow + 1}</strong>`;
            
            document.getElementById('counterVal').innerText = counterPercent + "%";
            // No row description for counter, as the row changes based on what the rival picks
        }

        function updateAll() {
            const target = parseInt(document.getElementById('targetGoal').value);
            const rivalStart = parseInt(document.getElementById('rivalStart').value);
            
            renderDashboard(target, rivalStart);
            renderCustomBuilder();
            calculateOverallStats(target);
        }

        updateAll();
    </script>
</body>
</html>
